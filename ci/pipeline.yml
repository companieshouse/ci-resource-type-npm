jobs:
- name: publish
  plan:
  - get: source-code
    trigger: true
  - put: master
    params:
      build: source-code
    get_params:
      save: true
  - task: test
    image: master
    config:
      platform: linux
      inputs:
      - name: source-code
      caches:
      - path: cache/npm
      params:
        TEST_RUNNER: shell
        TEST_REGISTRY: ((test.registry))
        CORRECT_CREDENTIALS: ((test.credentials.good))
        INCORRECT_CREDENTIALS: ((test.credentials.bad))
        NEXUS_WORKAROUND: true
        NORMRF: false
      run:
        path: sh
        args:
        - -exc
        - |
          export NPM_CONFIG_CACHE=$PWD/cache/npm
          cd source-code/test
          npm install
          npm test
  - put: latest
    params:
      load: master
    get_params:
      skip_download: true
resources:
- name: source-code
  type: git
  source:
    uri: https://github.com/timotto/concourse-npm-resource.git
- name: master
  type: docker-image
  webhook_token: ((docker.webhook_token))
  check_every: 24h
  source:
    repository: timotto/concourse-npm-resource
    tag: master
    username: ((docker.username))
    password: ((docker.password))
- name: latest
  type: docker-image
  source:
    repository: timotto/concourse-npm-resource
    tag: latest
    username: ((docker.username))
    password: ((docker.password))
